# 마마무 솔라와 롤의 리신의 자리를 대체하며 최근에 많은 사랑을 받고 있는 Elastic Search
인덱스, 타입, 문서, 필드 구조로 구성된다
## 구성 요소
### 인덱스
데이터 저장 공간. 하나의 타입만을 가지며. 하나의 인덱스가 여러 노드에 분산 저장되어 관리된다
### 샤드
인덱스 내부에 색인된 데이터는 물라적인 공간에 여러 개의 파티션으로 나뉘어 구성되는데, 아 파티션을 엘라스틱서치에서는 shard라고 한다
### 타입
인덱스의 논리적 구조를 의미하며, 인덱스 속성에 따라 분류하기도 한다. 인덱스 당 하나의 타입만 사용할 수 있다. 현재는 타입 사용이 권장되지 않음.      
과거에는 인덱스 아래 타입을 여러개 둬서 카테고리를 분류했지만, 이제는 여러개의 인덱스로 간다.    
### 문서
엘라스틱 서치에서 데이터가 저장되는 최소 단위. 하나의 문서는 다수의 필드로 구성돼 있는데 각 필드는   
데이터 형태에 따라 용도에 맞는 데이터 타입을 정의해야 한다. 중첩 구조를 지원한다    
문서 안에 문서를 지정하는 것도 가능하다
### 필드
문서를 구성하기 위한 속성. 필드는 좀 더 동적(Dynamic)인 데이터 타입이다
### 매핑
문서의 필드와 필드의 속성을 정의하고 그에 따른 색인 방법을 정의하는 프로세스

## 노드
### 마스터 노드
클러스터와 관련된 전반적인 작업. ex) 인덱스 생성, 삭제
### 데이터 노드
문서가 실제로 저장되는 샤드가 배치되는 노드
### 코디네이팅 노드
들어온 요청을 라운드로빈 방식으로 분산시켜 주는 노드
### 인제스트 노드
섹인에 앞서 데이터를 전처리하기 위한 노드

## 인덱스
### 인덱스 관리 API
인덱스 관리
인덱스 생성할 떄는 매핑이라는 세부 설정을 이용할 수 있는데 매핑은 문서와 문서에 포함된 필드, 필드 타입 등을 세세하게 지정하는 것이 가능한 설정 방식 이다.      
한번 생성한 매핑 정보는 변경이 안된다.   

### 문서 관리 API 
문서의 추가 / 수정 / 삭제     
엘라스틱서치는 기본적으로 검색엔진이기 때문에 검색을 위해 다양한 검색 패턴을 지원하는 Search API를 별도로 제공한다    
색인된 문서의 ID를 기준으로 한 건의의 문서를 다뤄야하는 경우 문서 관리 API를 사용한다     
- index API : 한 건의 문서를 색인한다
- Get API : 한 건의 문서를 조회한다
- Delete API : 한 건의 문서를 삭제한다
- Update API : 한 건의 문서를 업데이트한다   
**Multi-document API**
- Multi Get API : 다수의 문서를 조회한다
- Bulk API : 대량의 문서를 색인한다
- Delete By Query API : 다수의 문서를 삭제한다
- Update By Query API : 다수의 문서를 업데이트한다
- Reindex API : 인덱스의 문서를 다시 색인한다
### 검색 API
문서 조회    
엘라스틱서치 검색 API의 사용 방식은 두 가지로 나뉜다
1. HTTP URI 형태의 파라미터를 URI에 추가해 검색하는 방법
2. RESTful API 방식인 QueryDSL을 사용해 요청 본문(Request Body)에 질의 내용을 추가해 검색하는 방법
현업에서는 Request Body 방식을 선호한다. 두가지를 섞어 사용하는 것도 가능하다
**QueryDSL**을 사용하면 가독성이 높고, JSON 형식으로 다양한 표현이 가능해진다. Query의 조건을 여러 개 만들거나,     
통계를 위한 집계(Aggregation) 쿼리 등 복잡한 쿼리를 작성하려면 QueryDSL을 사용하는 것이 좋다.    
URI로 여러 단계의 구조를 가지는 중첩된 형태 표현하는 것은 불가능하기 떄문이다    
q 파라미터를 사용해 해당 용어와 일치하는 문서만 조회한다. HTTP 메소드 POST를 사용한다     
q 파라미터를 사용할 때 별도의 필드명을 지정하지 않으면 존재하는 모든 필드를 대상으로 검색을 수행함     
**Request Body 방식의 검색 질의**   
JSON 포맷을 이용해 RESTful 방식으로 질의하면 매우 복잡한 쿼리도 쉽게 표현할 수 있고 여러 조건을 한 번에 처리할 수 있다
URI 쿼리의 파라미터를 JSON 포맷으로 옮기면 된다     
### 집계 API
문서 통계    
과거에는 통계 작업을 위해 루씬이 제공하는 패싯(Facets) 기능을 많이 활용했다. 하지만 패싯 기능은 기본적으로 디스크 기반으로 동작했고,   
분산 환경에는 최적화되지 않았기 떄문에 대용량의 데이터의 통계 작업에는 적합하지 않았다.    
5.0 이후에는 메모리 기반으로 변경 했기 때문에 대용량의 데이터 통계 작업이 가능해졌다      
집계 기능은 네가지 API로 제공된다. 기능을 서로 조합해 사용할 수 있으며 매우 강력한 기능 제공이 가능해진다
- 버킷 집계 Bucket Aggregation
집계 중 가장 많이 사용한다. 문서의 필드를 기준으로 버킷을 집계한다
- 메트릭 집계 Metric Aggregation
문서에서 추출된 값을 가지고 Sum, Max, Min, Avg를 계산한다
- 매트릭스 집계 Matrix Aggregation
행렬의 값을 합하거나 곱한다
- 파이프라인 집계 Pipeline Aggregation
버킷에서 도출된 결과 문서를 다른 필드 값으로 재분류한다. 다른 집계에 의해 생성된 출력 결과를 다시 한번 집계한다

---
### 스키마리스(Schemaless)
스키마리스(Schemaless)라는 기능은 인덱스 생성 과정 없이 문서를 추가해도 색인되도록 지원하는 기능    
강력한 기능을 제공하며, 다양한 형태의 비정형 데이터를 하나의 인덱스로 구성할 수 있다    
데이터에 대한 매핑을 자동으로 생성하는 편리한 기능을 제공한다 
# 참고 
- https://gem1n1.tistory.com/83 velog님의 블로그는 항상 정리가 잘 되어져있다

# Issue
## Elastic Search
> The mapping definition cannot be nested under a type [_doc] unless include_type_name is set to true
Mapping types are no longer supported in versions 7.x. My suggestion is to remove _doc type from your mappings.      
     
https://stackoverflow.com/questions/58824489/where-to-put-include-type-name-in-config-exs
## Kibana
> connect ECONNREFUSED 0.0.0.0:9200     
     
아 도커 container 자기 스스로를 찌르고 있구나...